<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æœ¬åœ°é“¾æ¥ç”Ÿæˆå™¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --brand: #1e80ff; --brand-dark: #1765cc; --bg: #f5f7fb; --card: #fff;
      --text: #1f2328; --muted: #6b7280; --border: #e5e7eb; --radius: 14px;
      --good: #10b981; --warn: #ef4444;
    }
    * { box-sizing: border-box; }
    body { font-family: "Segoe UI","PingFang SC",system-ui,-apple-system,Arial,sans-serif;
      color:var(--text); background: var(--bg); margin:0; }
    .container { max-width: 980px; margin: 40px auto; padding: 0 20px; }
    .nav { display:flex; justify-content: space-between; align-items:center; margin-bottom: 16px; }
    .nav a { color: var(--brand); text-decoration: none; font-weight: 600; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(0,0,0,.06); padding:24px; margin-top:16px; }
    h1 { margin:0 0 6px; font-size:26px; }
    p.desc { margin:0 0 18px; color:var(--muted); }
    label { font-size:13px; color:var(--muted); display:block; margin-bottom:6px; }
    input[type=text], select, textarea { width:100%; padding:12px 14px; border-radius:10px;
      border:1px solid var(--border); font-size:14px; background:#fbfcff; outline:none; }
    textarea { min-height: 140px; font-family: ui-monospace,Consolas,monospace; }
    .row { display:grid; grid-template-columns: 1fr 200px; gap:12px; }
    .row + .row { margin-top: 12px; }
    .actions { margin-top:14px; display:flex; gap:12px; flex-wrap:wrap; }
    button { padding:11px 16px; border-radius:10px; border:1px solid var(--brand);
      background:var(--brand); color:#fff; cursor:pointer; font-weight:600; }
    button:hover { background: var(--brand-dark); }
    .btn-secondary { background:#fff; color:var(--brand); border-color:var(--border); }
    .btn-secondary:hover { border-color: var(--brand); background:#f7faff; }
    .result { margin-top:16px; padding:14px; border:1px dashed var(--border); border-radius:10px; background:#f9fbff; }
    .mono { font-family: ui-monospace,Consolas,monospace; }
    .muted { color: var(--muted); }
    table { width:100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom:1px solid var(--border); padding:8px 6px; font-size: 14px; }
    th { text-align:left; color:#374151; }
    .ok { color: var(--good); }
    .bad { color: var(--warn); }
    .hint { font-size: 13px; color: var(--muted); margin-top: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="mono muted">æœ¬åœ°è¿è¡Œ Â· åªåœ¨ä½ çš„ç”µè„‘ä¸Šæ‰“å¼€</div>
      <div><a href="/static/links.html">ğŸ“œ çŸ­é“¾å†å²</a></div>
    </div>

    <!-- å•æ¡ç”Ÿæˆ -->
    <div class="card">
      <h1>ğŸ”— å•æ¡ç”Ÿæˆ</h1>
      <p class="desc">è¾“å…¥ç»å¯¹è·¯å¾„ â†’ é€‰æ‹©åŠ¨ä½œ â†’ ç”ŸæˆçŸ­é“¾ï¼ˆæ›´ç¾è§‚ï¼‰ã€‚ç‚¹å‡»çŸ­é“¾ä¼šè·³åˆ°å®Œæ•´é“¾æ¥å¹¶åœ¨æœ¬æœºæ‰§è¡Œæ‰“å¼€ã€‚</p>

      <div class="row">
        <div>
          <label>ç»å¯¹è·¯å¾„</label>
          <input id="target" type="text" placeholder='ä¾‹å¦‚ D:/CODE/fastapi_app æˆ– D:\CODE\fastapi_app'>
        </div>
        <div>
          <label>åŠ¨ä½œ</label>
          <select id="action">
            <option value="open">æ‰“å¼€</option>
            <option value="reveal">å®šä½æ‰€åœ¨æ–‡ä»¶å¤¹</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>è‡ªå®šä¹‰çŸ­é“¾ï¼ˆå¯é€‰ï¼Œå­—æ¯æ•°å­—ï¼‰</label>
          <input id="alias" type="text" placeholder="ä¾‹å¦‚ fastapi">
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="actions">
            <button id="btnGen">ç”Ÿæˆé“¾æ¥</button>
            <button class="btn-secondary" id="btnNormalize" type="button">æ ¼å¼åŒ–è·¯å¾„</button>
          </div>
        </div>
      </div>

      <div id="singleResult" class="result" style="display:none;">
        <div>çŸ­é“¾ï¼š<a id="singleShort" href="#" target="_blank" class="mono"></a>
          <button id="copySingleShort" class="btn-secondary" type="button">å¤åˆ¶çŸ­é“¾</button>
        </div>
        <div style="margin-top:8px;">å®Œæ•´ï¼š<a id="singleFull" href="#" target="_blank" class="mono"></a>
          <button id="copySingleFull" class="btn-secondary" type="button">å¤åˆ¶å®Œæ•´é“¾æ¥</button>
        </div>
        <div id="singleNote" class="hint"></div>
      </div>

      <div class="hint">
        ğŸ’¡ Windowsï¼šèµ„æºç®¡ç†å™¨é€‰ä¸­æ–‡ä»¶/æ–‡ä»¶å¤¹ â†’ <span class="mono">Shift + å³é”® â†’ å¤åˆ¶ä¸ºè·¯å¾„</span>ã€‚
      </div>
    </div>

    <!-- æ‰¹é‡ç”Ÿæˆ -->
    <div class="card">
      <h1>ğŸ“¦ æ‰¹é‡ç”Ÿæˆ</h1>
      <p class="desc">æ¯è¡Œä¸€æ¡ã€‚æ”¯æŒæ ¼å¼ï¼š<span class="mono">è·¯å¾„</span> æˆ– <span class="mono">åˆ«å | è·¯å¾„</span>ï¼ˆç«–çº¿å‰åå¯æœ‰ç©ºæ ¼ï¼‰ã€‚</p>

      <div class="row">
        <div>
          <label>æ‰¹é‡è¾“å…¥</label>
          <textarea id="batchInput" placeholder="ç¤ºä¾‹ï¼š&#10;D:/CODE/fastapi_app&#10;proj1 | D:/docs/æŠ¥å‘Š.pdf&#10;music | D:/Music/playlist.m3u8"></textarea>
        </div>
        <div>
          <label>åŠ¨ä½œ</label>
          <select id="batchAction">
            <option value="open">æ‰“å¼€</option>
            <option value="reveal">å®šä½æ‰€åœ¨æ–‡ä»¶å¤¹</option>
          </select>
          <div class="actions">
            <button id="btnBatch">æ‰¹é‡ç”Ÿæˆ</button>
            <button class="btn-secondary" id="btnBatchNormalize" type="button">æ ¼å¼åŒ–æ¯è¡Œ</button>
          </div>
        </div>
      </div>

      <div id="batchResult" class="result" style="display:none;">
        <div class="actions">
          <button class="btn-secondary" id="btnCopyAllShort" type="button">å¤åˆ¶å…¨éƒ¨çŸ­é“¾</button>
          <button class="btn-secondary" id="btnGoHistory" type="button" onclick="location.href='/static/links.html'">æŸ¥çœ‹å†å²</button>
        </div>
        <table id="batchTable">
          <thead>
            <tr><th>åˆ«å</th><th>è·¯å¾„</th><th>çŸ­é“¾</th><th>å®Œæ•´é“¾æ¥</th><th>çŠ¶æ€</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="hint">âš ï¸ æµè§ˆå™¨å‡ºäºå®‰å…¨é™åˆ¶ï¼Œæ— æ³•é€šè¿‡æ‹–æ‹½/æ–‡ä»¶é€‰æ‹©æ‹¿åˆ°â€œç»å¯¹è·¯å¾„â€ï¼Œè¯·ä»èµ„æºç®¡ç†å™¨å¤åˆ¶ã€‚</div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);

    // ===== å•æ¡ =====
    const target = $('#target'), action = $('#action'), alias = $('#alias');
    const btnGen = $('#btnGen'), btnNormalize = $('#btnNormalize');
    const singleResult = $('#singleResult'), singleShort = $('#singleShort'), singleFull = $('#singleFull');
    const copySingleShort = $('#copySingleShort'), copySingleFull = $('#copySingleFull'), singleNote = $('#singleNote');

    function normalizePath(p){ if(!p) return ''; let s=p.trim();
      if((s.startsWith('"')&&s.endsWith('"'))||(s.startsWith("'")&&s.endsWith("'"))) s=s.slice(1,-1);
      return s.replace(/\\/g,'/'); }

    btnNormalize.addEventListener('click', ()=>{ target.value = normalizePath(target.value); });

    btnGen.addEventListener('click', async ()=>{
      const t = normalizePath(target.value);
      if(!t){ alert('è¯·è¾“å…¥ç»å¯¹è·¯å¾„'); return; }
      const params = new URLSearchParams({ target: t, action: action.value });
      if(alias.value.trim()) params.set('alias', alias.value.trim());
      const resp = await fetch(`/gen?${params.toString()}`);
      const data = await resp.json();
      singleResult.style.display = '';
      if(!resp.ok){
        singleShort.removeAttribute('href'); singleFull.removeAttribute('href');
        singleShort.textContent = ''; singleFull.textContent = '';
        singleNote.innerHTML = `<span class="bad">âŒ é”™è¯¯ï¼š</span><span class="mono">${data.detail || JSON.stringify(data)}</span>`;
        return;
      }
      singleShort.href = data.short_url; singleShort.textContent = data.short_url;
      singleFull.href = data.full_url; singleFull.textContent = data.full_url;
      singleNote.textContent = 'çŸ­é“¾æ›´ç¾è§‚ï¼Œå¯ç›´æ¥æ”¾ Notion/æ–‡æ¡£ã€‚';
    });

    copySingleShort.addEventListener('click', async ()=>{ if(singleShort.href){ await navigator.clipboard.writeText(singleShort.href); copySingleShort.textContent='å·²å¤åˆ¶'; setTimeout(()=>copySingleShort.textContent='å¤åˆ¶çŸ­é“¾',1200);} });
    copySingleFull .addEventListener('click', async ()=>{ if(singleFull.href ){ await navigator.clipboard.writeText(singleFull.href ); copySingleFull .textContent='å·²å¤åˆ¶'; setTimeout(()=>copySingleFull .textContent='å¤åˆ¶å®Œæ•´é“¾æ¥',1200);} });

    // ===== æ‰¹é‡ =====
    const batchInput = $('#batchInput'), batchAction = $('#batchAction');
    const btnBatch = $('#btnBatch'), btnBatchNormalize = $('#btnBatchNormalize');
    const batchResult = $('#batchResult'), batchTable = $('#batchTable tbody'), btnCopyAllShort = $('#btnCopyAllShort');

    function parseBatch(text){
      const lines = text.split(/\r?\n/);
      const items = [];
      for(const line of lines){
        const raw = line.trim();
        if(!raw) continue;
        // æ”¯æŒ â€œalias | pathâ€ æˆ– åªæœ‰ â€œpathâ€
        const m = raw.split('|');
        if(m.length >= 2){
          const alias = m[0].trim();
          const path  = normalizePath(m.slice(1).join('|').trim());
          items.push({ alias, target: path });
        }else{
          items.push({ target: normalizePath(raw) });
        }
      }
      return items;
    }

    btnBatchNormalize.addEventListener('click', ()=>{
      const items = parseBatch(batchInput.value);
      const out = items.map(x => x.alias ? `${x.alias} | ${x.target}` : x.target).join('\n');
      batchInput.value = out;
    });

    btnBatch.addEventListener('click', async ()=>{
      const items = parseBatch(batchInput.value);
      if(items.length===0){ alert('è¯·è¾“å…¥è‡³å°‘ä¸€è¡Œè·¯å¾„'); return; }
      const body = JSON.stringify({ items, action: batchAction.value });
      const resp = await fetch('/gen_batch', { method:'POST', headers:{'Content-Type':'application/json'}, body });
      const data = await resp.json();

      batchResult.style.display = '';
      batchTable.innerHTML = '';
      if(!resp.ok){
        batchTable.innerHTML = `<tr><td colspan="5" class="bad mono">${data.detail || JSON.stringify(data)}</td></tr>`;
        return;
      }
      const rows = [];
      for(const it of data.items){
        if(it.error){
          rows.push(`<tr>
            <td class="mono">${it.alias || ''}</td>
            <td class="mono">${it.target || ''}</td>
            <td class="bad">â€”</td>
            <td class="bad">â€”</td>
            <td class="bad">âŒ ${it.error}</td>
          </tr>`);
        }else{
          rows.push(`<tr>
            <td class="mono">${it.alias || ''}</td>
            <td class="mono">${it.target}</td>
            <td><a class="mono" href="${it.short_url}" target="_blank">${it.short_url}</a></td>
            <td><a class="mono" href="${it.full_url}" target="_blank">å®Œæ•´</a></td>
            <td class="ok">âœ… OK</td>
          </tr>`);
        }
      }
      batchTable.innerHTML = rows.join('');
    });

    btnCopyAllShort.addEventListener('click', async ()=>{
      const urls = Array.from(batchTable.querySelectorAll('a[href^="/"], a[href^="http"]'))
        .filter(a => a.textContent.startsWith('http://') || a.href.includes('/s/'))
        .map(a => a.href)
        .filter(href => href.includes('/s/')); // åªå¤åˆ¶çŸ­é“¾
      if(urls.length===0){ alert('æ²¡æœ‰å¯å¤åˆ¶çš„çŸ­é“¾'); return; }
      await navigator.clipboard.writeText(urls.join('\n'));
      btnCopyAllShort.textContent = 'å·²å¤åˆ¶';
      setTimeout(()=>btnCopyAllShort.textContent='å¤åˆ¶å…¨éƒ¨çŸ­é“¾',1200);
    });
  </script>
</body>
</html>
